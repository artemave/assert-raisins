#!/usr/bin/env node

const {spawn} = require('child_process')
const path = require('path')
const parseArgv = require('../parseArgv')

const {node_args, file_args, donc_args} = parseArgv(process.argv.slice(2))

if (!file_args.length) {
  console.error('No test files given/found.')
  process.exit(1)
}

const child_args = [
  ...node_args,
  ...file_args,
  path.join(__dirname, '..', 'runner.js'),
  ...donc_args
]

const proc = spawn(process.execPath, child_args, { stdio: 'inherit' })

proc.on('exit', (code, signal) => {
  process.on('exit', () => {
    if (signal) {
      process.kill(process.pid, signal)
    } else {
      process.exit(code)
    }
  })
})

process.on('SIGINT', () => {
  proc.kill('SIGINT')
  proc.kill('SIGTERM') // if that didn't work, we're probably in an infinite loop, so make it die.
})
