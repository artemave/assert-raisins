#!/usr/bin/env node

const glob = require('glob')
const {spawn} = require('child_process')
const path = require('path')

function isDoncArg(arg) {
  return arg.match(/--only=/)
}

const node_args = []
const donc_args = []
let skip_require_next_file = false

for (const arg of process.argv.slice(2)) {
  if (isDoncArg(arg)) {
    donc_args.push(arg)
  } else if (skip_require_next_file) {
    node_args.push(arg)
  } else {
    const files = glob.sync(arg)

    if (files.length) {
      for (const file of files) {
        node_args.push('-r', `./${file}`)
      }
    } else {
      node_args.push(arg)
    }
  }

  skip_require_next_file = arg === '-r'
}

node_args.push(path.join(__dirname, '../runner.js'))
node_args.push(...donc_args)

const proc = spawn(process.execPath, node_args, {
  stdio: 'inherit'
})

proc.on('exit', (code, signal) => {
  process.on('exit', () => {
    if (signal) {
      process.kill(process.pid, signal)
    } else {
      process.exit(code)
    }
  })
})

process.on('SIGINT', () => {
  proc.kill('SIGINT')
  proc.kill('SIGTERM') // if that didn't work, we're probably in an infinite loop, so make it die.
})
